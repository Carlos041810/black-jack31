<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Royal Blackjack Casino</title>
    <link rel="stylesheet" href="/css/inicio.css">
    <style>
        /* Estilos para la nueva tabla de mesas */
        #available-tables-container {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
        }
        .tables-header, .table-row {
            display: grid;
            grid-template-columns: 2fr 1.5fr 1fr; /* Mesa | Jugadores | Acci√≥n */
            gap: 15px;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .tables-header {
            font-weight: bold;
            color: #D4AF37; /* Dorado */
            text-transform: uppercase;
            font-size: 0.9em;
            border-bottom: 2px solid #D4AF37;
            margin-bottom: 5px;
        }
        .table-row {
            font-size: 1em;
            transition: background-color 0.2s;
        }
        .table-row:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        .table-cell.action-cell {
            text-align: right;
        }
    </style>
</head>

<body>
    <!--* Cartas flotantes *-->
    <div class="floating-cards card-1">‚ô†</div>
    <div class="floating-cards card-2">‚ô•</div>
    <div class="floating-cards card-3">‚ô£</div>
    <div class="floating-cards card-4">‚ô¶</div>
    <div class="login-container">
        <div class="logo">
            <div class="subtitle">Premium Casino Experience</div>
        </div>
        <div class="welcome-message">
            Bienvenido al casino m√°s exclusivo<br>
            <strong>¬øC√≥mo deseas ingresar?</strong>
        </div>
        <div class="options-container">
            <div class="option-card dealer-card">
                <div class="option-title">INGRESAR COMO DEALER</div>
                <div class="option-description">
                    Controla las mesas, administra los juegos y gestiona la experiencia de los jugadores
                </div>
                <button class="option-button" id="dealerBtn" onclick="enterAsDealer()">ACCEDER COMO DEALER</button>
            </div>
            <div class="option-card player-card">
                <div class="option-title">INGRESAR COMO JUGADOR</div>
                <div class="option-description">
                    √önete a una de las mesas disponibles para empezar a jugar.
                </div>
                <div id="available-tables-container">
                    <!-- Las mesas disponibles se cargar√°n aqu√≠ -->
                </div>
            </div>
        </div>

    </div>

    <!--* Modal para c√≥digo de mesa *-->
    <div class="modal" id="codeModal">
        <div class="modal-content" id="player-modal-content">
            <h3 id="modal-title">üÉè Unirse a Mesa</h3>
            <p style="color: #ccc; margin-bottom: 20px;">Ingresa tu nombre para unirte a la mesa.</p>
            <input type="text" class="code-input" id="playerNameInput" placeholder="Tu nombre" maxlength="30"
                   style="margin-bottom: 20px;">

            <div class="modal-buttons">
                <button class="modal-btn join-btn" id="joinBtn" onclick="joinRoom()">UNIRSE</button>
                <button class="modal-btn cancel-btn" onclick="closeModal()">CANCELAR</button>
            </div>
        </div>
    </div>

    <!--* Modal de loading *-->
    <div class="modal" id="loadingModal">
        <div class="modal-content">
            <h3>üé∞ Creando Mesa</h3>
            <p style="color: #ccc; margin-bottom: 20px;">Preparando tu mesa de blackjack...</p>
            <div class="loading-spinner">‚ö°</div>
        </div>
    </div>

    <script>
        let selectedRoomCode = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadAvailableTables();
        });

        async function loadAvailableTables() {
            const container = document.getElementById('available-tables-container');
            container.innerHTML = '<div class="loading-tables">Buscando mesas...</div>';

            try {
                const response = await fetch('/mesas-disponibles');
                const data = await response.json();

                if (data.success && data.mesas.length > 0) {
                    // Crear la cabecera de la tabla
                    container.innerHTML = `
                        <div class="tables-header">
                            <div class="header-cell">Mesa</div>
                            <div class="header-cell">Jugadores</div>
                            <div class="header-cell action-cell">Acci√≥n</div>
                        </div>
                    `;
                    
                    // A√±adir cada mesa como una fila
                    data.mesas.forEach(mesa => {
                        const tableElement = document.createElement('div');
                        tableElement.className = 'table-row';
                        tableElement.innerHTML = `
                            <div class="table-cell">${mesa.dealer}</div>
                            <div class="table-cell">${mesa.jugadores_actual - 1} / 3</div>
                            <div class="table-cell action-cell">
                                <button class="option-button join-table-btn" onclick="showPlayerNameModal('${mesa.codigo}')">UNIRSE</button>
                            </div>
                        `;
                        container.appendChild(tableElement);
                    });

                } else {
                    container.innerHTML = '<div class="no-tables-msg">No hay mesas disponibles en este momento.</div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="no-tables-msg">Error al cargar las mesas.</div>';
                console.error('Error al cargar mesas:', error);
            }
        }

        async function enterAsDealer() {
            const dealerBtn = document.getElementById('dealerBtn');
            const loadingModal = document.getElementById('loadingModal');

            try {
                loadingModal.style.display = 'flex';
                dealerBtn.disabled = true;
                dealerBtn.textContent = 'CREANDO MESA...';

                const response = await fetch('/crear-mesa', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dealer: 'Dealer Principal' })
                });

                const data = await response.json();

                if (data.success) {
                    console.log('Mesa creada con c√≥digo:', data.codigo);
                    window.location.href = `/dealer?codigo=${data.codigo}`;

                    // Emitir evento con el c√≥digo
                    const event = new CustomEvent('mesaCreada', { detail: data.codigo });
                    window.dispatchEvent(event);
                } else {
                    throw new Error(data.error || 'Error desconocido al crear la mesa');
                }
            } catch (error) {
                console.error('Error al crear la mesa:', error);
                alert('Error al crear la mesa: ' + error.message);

                loadingModal.style.display = 'none';
                dealerBtn.disabled = false;
                dealerBtn.textContent = 'ACCEDER COMO DEALER';
            }
        }

        async function joinRoom() {
            const playerName = document.getElementById('playerNameInput').value;
            const joinBtn = document.getElementById('joinBtn');
            if (!playerName.trim()) {
                alert('Por favor ingresa tu nombre para unirte a la mesa.');
                return;
            }

            try {
                joinBtn.disabled = true;
                joinBtn.textContent = 'CONECTANDO...';

                const response = await fetch('/verificar-mesa', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ codigo: selectedRoomCode })
                });

                const data = await response.json();

                if (data.success) {
                    console.log(`Mesa ${selectedRoomCode} verificada. Uni√©ndose...`);
                    window.location.href = `/player?codigo=${selectedRoomCode}&nombre=${encodeURIComponent(playerName)}`;
                } else {
                    throw new Error(data.error || 'No se pudo unir a la mesa.');
                }
            } catch (error) {
                console.error('Error al verificar la mesa:', error);
                alert('Error: ' + error.message);

                joinBtn.disabled = false;
                joinBtn.textContent = 'UNIRSE';
            }
        }

        function showPlayerNameModal(roomCode) {
            selectedRoomCode = roomCode;
            document.getElementById("codeModal").style.display = "flex";
            document.getElementById("playerNameInput").focus();
        }

        function closeModal() {
            document.getElementById("codeModal").style.display = "none";
        }

    </script>

</body>

</html>